<!doctype html>
<html>
<head>
  <title>Pega DSS Update Tool</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #111; color: #eee; }
    .wrapper { display: flex; min-height: 100vh; }
    .form-section, .json-section { padding: 2rem; flex: 1; }
    .form-section { background: #222; border-right: 2px solid #333; }
    .json-section { background: #1a1a1a; }
    .dss-entry { border: 1px solid #444; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
    input, select, button { padding: 8px; margin-bottom: 10px; width: 100%; }
    .btn { background: #28a745; color: #fff; border: none; cursor: pointer; }
    .btn-remove { background: #e74c3c; margin-top: 10px; }
    .btn-action { background: #0069d9; margin-top: 1rem; }
    pre { background: #000; padding: 1rem; overflow-x: auto; border-radius: 8px; font-size: 0.9rem; }
  </style>
</head>
<body>
<div class="wrapper">
  <!-- LEFT: FORM -->
  <div class="form-section">
    <h2>Update DSS</h2>
    <form method="post" id="dssForm">
      <label>Environment:</label>
      <select name="environment" id="environment" onchange="updateJson()" required>
        {% for env in environments %}
          <option value="{{ env }}">{{ env }}</option>
        {% endfor %}
      </select>

      <div id="entries"></div>
      <button type="button" onclick="addEntry()" class="btn">+ Add New</button>
      <br><br>
      <button type="button" onclick="reconfirmAndSubmit()" class="btn">üõ°Ô∏è Reconfirm & Submit</button>
    </form>
  </div>

  <!-- RIGHT: JSON PREVIEW -->
  <div class="json-section">
    <h3>Selected Environment URL</h3>
    <pre id="selectedUrl">[ No URL selected ]</pre>

    <h3>Payload Preview</h3>
    <pre id="jsonPreview">[]</pre>

    <button onclick="copyJson()" class="btn-action">üìã Copy to Clipboard</button>
    <button onclick="downloadJson()" class="btn-action">üíæ Download JSON</button>
    <button onclick="sendToMock()" class="btn-action">üß™ Send to Mock API</button>
    <div id="mockResponse" style="margin-top:1rem; font-size:0.9rem;"></div>
  </div>
</div>

<script>
let config = {{ environments | tojson }};
let entryId = 0;

// Add one default entry on load
addEntry();

function addEntry() {
  const container = document.getElementById('entries');
  const div = document.createElement('div');
  div.className = 'dss-entry';
  div.innerHTML = `
    <input type="text" name="owning_ruleset_${entryId}" placeholder="OwningRuleset" oninput="updateJson()" required>
    <input type="text" name="setting_purpose_${entryId}" placeholder="SettingPurpose" oninput="updateJson()" required>
    <input type="text" name="new_value_${entryId}" placeholder="NewValue" oninput="updateJson()" required>
    <button type="button" class="btn btn-remove" onclick="this.parentElement.remove(); updateJson();">Remove</button>
  `;
  container.appendChild(div);
  entryId++;
  updateJson();
}

function getJsonPayload(includeUrl = false) {
  const formData = new FormData(document.getElementById('dssForm'));
  const selectedEnv = formData.get('environment');
  const dssList = [];

  for (let [key, value] of formData.entries()) {
    if (key.startsWith('owning_ruleset_')) {
      const id = key.split('_').pop();
      const setting = formData.get(`setting_purpose_${id}`);
      const newVal  = formData.get(`new_value_${id}`);
      if (setting && newVal) {
        dssList.push({
          "OwningRuleset": value,
          "SettingPurpose": setting,
          "NewValue": newVal
        });
      }
    }
  }

  return includeUrl
    ? { url: config[selectedEnv] || "", entries: dssList }
    : dssList;
}

function updateJson() {
  const payload = getJsonPayload(false); // just entries
  document.getElementById('jsonPreview').textContent = JSON.stringify(payload, null, 2);

  // Update selected URL display
  const selectedEnv = document.getElementById('environment').value;
  const envUrl = config[selectedEnv] || "(not found)";
  document.getElementById('selectedUrl').textContent = envUrl;
}

function reconfirmAndSubmit() {
  const payloadWithUrl = getJsonPayload(true); // show in confirm
  const pretty  = JSON.stringify(payloadWithUrl, null, 2);
  const confirmMsg = `Please confirm the following payload (including URL):\n\n${pretty}\n\nProceed?`;
  if (confirm(confirmMsg)) {
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'jsonPayload';
    hiddenInput.value = JSON.stringify(getJsonPayload(false)); // only DSS entries
    document.getElementById('dssForm').appendChild(hiddenInput);
    document.getElementById('dssForm').submit();
  }
}

function copyJson() {
  navigator.clipboard.writeText(document.getElementById('jsonPreview').textContent)
    .then(() => alert("Copied to clipboard!"));
}

function downloadJson() {
  const blob = new Blob(
    [document.getElementById('jsonPreview').textContent],
    { type: 'application/json' }
  );
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'dss_payload.json';
  link.click();
}

function sendToMock() {
  const cleanPayload = getJsonPayload(false);
  fetch('https://httpbin.org/post', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(cleanPayload)
  })
  .then(r => r.json())
  .then(d => {
    document.getElementById('mockResponse').innerHTML =
      "<strong>Mock API replied with:</strong><br><pre>" +
      JSON.stringify(d.json, null, 2) + "</pre>";
  })
  .catch(err => {
    document.getElementById('mockResponse').textContent = "Error: " + err;
  });
}
</script>
</body>
<a href="/logs" style="color: #0af; display: block; margin-top: 1rem;">üîé View Sent DSS Logs</a>
</html>
