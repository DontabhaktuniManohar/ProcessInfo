<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container py-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="card-title mb-4">Select Environment and Flag</h3>

                <form id="deploymentForm">
                    <div class="mb-3">
                        <label for="environment" class="form-label">Select SIT Environment</label>
                        <select id="environment" class="form-select" required>
                            <option value="">--Select Environment--</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="flag" class="form-label">Select Flag</label>
                        <select id="flag" class="form-select" required>
                            <option value="">--Select Flag--</option>
                            <option value="Blue">Blue</option>
                            <option value="Green">Green</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Fetch Report</button>
                </form>

                <div id="responseTable" class="mt-4"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const sitEnvironments = ["SIT1", "SIT2", "SIT3", "SIT4", "SIT5"];
        const fixedEnvironments = ["PROD", "CANARY", "PRODE"];  // Always included
        const environmentSelect = document.getElementById('environment');
        const flagSelect = document.getElementById('flag');
        const form = document.getElementById('deploymentForm');
        const responseDiv = document.getElementById('responseTable');

        // Populate SIT Environment Dropdown
        sitEnvironments.forEach(env => {
            const option = document.createElement('option');
            option.value = env;
            option.textContent = env;
            environmentSelect.appendChild(option);
        });

        // Handle Form Submission
        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            responseDiv.innerHTML = ""; // Clear previous results

            const selectedSIT = environmentSelect.value;
            const selectedFlag = flagSelect.value;

            if (!selectedSIT || !selectedFlag) {
                alert("Please select an environment and flag.");
                return;
            }

            // Include selected SIT + fixed environments
            const environmentsToCheck = [selectedSIT, ...fixedEnvironments];

            let tableHTML = `
                <table class="table table-bordered mt-4">
                    <thead>
                        <tr>
                            <th>Environment</th>
                            <th>Artifact</th>
                            <th>Commit</th>
                            <th>BG Flag</th>
                            <th>Deploy By</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Loop through environments and fetch data
            for (let env of environmentsToCheck) {
                let bgflagValue = selectedFlag; // Default for SIT environments

                // If it's a fixed environment, set bgflag to NA
                if (fixedEnvironments.includes(env)) {
                    bgflagValue = "NA";
                }

                const apiUrl = `http://localhost:5000/api/deployment?bgflag=${bgflagValue}&environment=${env}`;
                console.log(apiUrl)
                
                    try {
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        
                        if (Object.keys(data).length > 0) {  // Check if API returned data
                            tableHTML += `
                                <tr>
                                    <td>${data.environment}</td>
                                    <td>${data.artifact}</td>
                                    <td>${data.commit}</td>
                                    <td>${data.bgflag}</td>
                                    <td>${data.deployby}</td>
                                    <td>${data.deploymentstatus}</td>
                                </tr>
                            `;
                        } else {
                            tableHTML += `
                                <tr>
                                    <td>${env}</td>
                                    <td colspan="5" class="text-center text-muted">No Data Found</td>
                                </tr>
                            `;
                        }
                    } catch (error) {
                        console.error("Error fetching API:", error);
                        tableHTML += `
                            <tr>
                                <td>${env}</td>
                                <td colspan="5" class="text-center text-danger">API Error</td>
                            </tr>
                        `;
                    }
            }

            tableHTML += `</tbody></table>`;
            responseDiv.innerHTML = tableHTML;
        });
    </script>

</body>
</html>
