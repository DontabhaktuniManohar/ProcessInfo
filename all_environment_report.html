<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deployment Status for Multiple Environments</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container py-5">
        <div class="card shadow-sm">
            <div class="card-body">
                <h3 class="card-title mb-4">Deployment Status Checker</h3>

                <form id="myForm">
                    <div class="mb-3">
                        <label for="flag" class="form-label">Blue/Green Flag</label>
                        <select id="flag" class="form-select" required>
                            <option value="">--Select Flag--</option>
                            <option value="Blue">Blue</option>
                            <option value="Green">Green</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Fetch Deployment for All Environments</button>
                </form>

                <div class="mt-4">
                    <h5>Deployment Results</h5>
                    <table class="table table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Environment</th>
                                <th>Artifact</th>
                                <th>Commit</th>
                                <th>Flag</th>
                                <th>Deployed By</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="deploymentTableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.getElementById("myForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const flag = document.getElementById("flag").value;
            const tableBody = document.getElementById("deploymentTableBody");

            if (!flag) {
                alert("Please select a flag (Blue or Green).");
                return;
            }

            tableBody.innerHTML = ""; // Clear table before updating
            const environments = ["SIT1", "SIT2", "SIT3", "SIT4", "SIT5"]; // List of environments

            for (const env of environments) {
                try {
                    const response = await fetch(`http://localhost:5000/api/deployment?bgflag=${flag}&environment=${env}`);
                    const data = await response.json();

                    console.log(`API Response for ${env}:`, data);

                    // Handle empty response
                    if (Object.keys(data).length === 0) {
                        data.artifact = "N/A";
                        data.commit = "N/A";
                        data.bgflag = flag;
                        data.deployby = "N/A";
                        data.deploymentstatus = "No Data";
                        data.environment = env;
                    }

                    const row = `
                        <tr>
                            <td>${data.environment}</td>
                            <td>${data.artifact}</td>
                            <td>${data.commit}</td>
                            <td>${data.bgflag}</td>
                            <td>${data.deployby}</td>
                            <td>${data.deploymentstatus}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                } catch (error) {
                    console.error(`Fetch Error for ${env}:`, error);
                    tableBody.innerHTML += `
                        <tr>
                            <td>${env}</td>
                            <td colspan="5" class="text-danger">Error fetching data</td>
                        </tr>
                    `;
                }
            }
        });
    </script>

</body>

</html>
